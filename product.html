<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ìƒí’ˆ ìƒì„¸</title>
    <style>
        body { font-family: sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; }
        .product-info { display: flex; gap: 30px; margin-bottom: 40px; border-bottom: 1px solid #ddd; padding-bottom: 20px; }
        .product-info img { width: 300px; height: 300px; object-fit: cover; }
        .review-item { background: #f9f9f9; padding: 15px; margin-bottom: 10px; border-radius: 5px; }
        .star { color: gold; }
        .btn-cart { padding: 10px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; }
    </style>
</head>
<body>
    <a href="index.html">â† ëª©ë¡ìœ¼ë¡œ</a>
    <div id="product-detail">ë¡œë”©ì¤‘...</div>

    <h3>ğŸ“ ìƒí’ˆ ë¦¬ë·°</h3>
    <div id="review-form" style="margin-bottom: 20px; padding: 15px; border: 1px solid #ddd;">
        <h4>ë¦¬ë·° ì‘ì„±</h4>
        <select id="rating">
            <option value="5">â­â­â­â­â­ (5ì )</option>
            <option value="4">â­â­â­â­ (4ì )</option>
            <option value="3">â­â­â­ (3ì )</option>
            <option value="2">â­â­ (2ì )</option>
            <option value="1">â­ (1ì )</option>
        </select>
        <input type="text" id="comment" placeholder="ë¦¬ë·° ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”" style="width: 60%;">
        <button onclick="writeReview()">ë“±ë¡</button>
    </div>
    <div id="review-list"></div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const productId = urlParams.get('id');
        const user = JSON.parse(localStorage.getItem('user'));

        async function loadProduct() {
            const res = await fetch('/api/products');
            const products = await res.json();
            const product = products.find(p => p.product_id == productId);

            document.getElementById('product-detail').innerHTML = `
                <div class="product-info">
                    <img src="${product.image_url}" onerror="this.src='https://placehold.co/300'">
                    <div>
                        <h1>${product.name}</h1>
                        <p>${product.category_name}</p>
                        <h2>${product.price.toLocaleString()}ì›</h2>
                        <input type="number" id="qty" value="1" min="1" style="width: 50px; padding: 5px;">
                        <button class="btn-cart" onclick="addToCart(${product.product_id})">ì¥ë°”êµ¬ë‹ˆ ë‹´ê¸°</button>
                    </div>
                </div>
            `;
            loadReviews();
        }

        // âœ… ìˆ˜ì •ëœ ì¥ë°”êµ¬ë‹ˆ ë‹´ê¸° í•¨ìˆ˜
        async function addToCart(id) {
            if (!user) return alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
            const qty = document.getElementById('qty').value;
            
            try {
                const response = await fetch('/api/cart', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        member_id: user.member_id, 
                        product_id: id, 
                        quantity: qty 
                    })
                });

                if(response.ok) {
                    // âœ… ì´ë™ ì§ˆë¬¸ ì—†ì´ ì„±ê³µ ë©”ì‹œì§€ë§Œ í‘œì‹œí•˜ê³  ë!
                    alert("ì¥ë°”êµ¬ë‹ˆì— ë‹´ê²¼ìŠµë‹ˆë‹¤.");
                } else {
                    alert("ë‹´ê¸° ì‹¤íŒ¨");
                }
            } catch (error) {
                console.error(error);
            }
        }

        async function loadReviews() {
            const res = await fetch(`/api/products/${productId}/reviews`);
            const reviews = await res.json();
            
            document.getElementById('review-list').innerHTML = reviews.map(r => `
                <div class="review-item">
                    <strong>${r.reviewer_name}</strong> 
                    <span class="star">${'â˜…'.repeat(r.rating)}</span>
                    <p>${r.comment}</p>
                    <small>${new Date(r.created_at).toLocaleDateString()}</small>
                </div>
            `).join('') || '<p>ì‘ì„±ëœ ë¦¬ë·°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
        }

        async function writeReview() {
            if (!user) return alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
            const rating = document.getElementById('rating').value;
            const comment = document.getElementById('comment').value;

            const res = await fetch('/api/reviews', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    member_id: user.member_id,
                    product_id: productId,
                    rating,
                    comment
                })
            });

            const result = await res.json();
            alert(result.message);
            if (res.ok) loadReviews();
        }

        loadProduct();
    </script>
</body>
</html>