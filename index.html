<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì—°ì„±FM</title>
    <style>
        body { font-family: sans-serif; padding: 20px; max-width: 1000px; margin: 0 auto; }
        header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #eee; padding-bottom: 20px; margin-bottom: 20px; }
        .product-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; }
        .product-card { border: 1px solid #ddd; padding: 15px; border-radius: 8px; text-align: center; }
        .product-card img { width: 100%; height: 150px; object-fit: cover; margin-bottom: 10px; cursor: pointer; }
        .btn { padding: 8px 15px; border: none; border-radius: 4px; cursor: pointer; margin: 2px; }
        .btn-primary { background-color: #0056b3; color: white; }
        .btn-secondary { background-color: #6c757d; color: white; } /* ì¥ë°”êµ¬ë‹ˆ ë²„íŠ¼ ìƒ‰ìƒ */
        .btn-danger { background-color: #dc3545; color: white; }
        .btn-cart { background-color: #28a745; color: white; } /* ìƒë‹¨ ì¥ë°”êµ¬ë‹ˆ ë²„íŠ¼ */
        /* ì¹´í…Œê³ ë¦¬ ë°” ìŠ¤íƒ€ì¼ */
        .category-bar { 
            display: flex; 
            gap: 10px; 
            margin-bottom: 20px; 
            padding: 10px 0; 
            overflow-x: auto; /* ëª¨ë°”ì¼ì—ì„œ ê°€ë¡œ ìŠ¤í¬ë¡¤ ê°€ëŠ¥ */
            white-space: nowrap;
            border-bottom: 1px solid #eee;
        }
        .cat-btn { 
            padding: 10px 20px; 
            border: 1px solid #ddd; 
            border-radius: 20px; 
            background: white; 
            cursor: pointer; 
            font-size: 14px;
            color: #555;
            transition: 0.3s;
        }
        .cat-btn:hover { background: #f0f0f0; }
        .cat-btn.active { 
            background: #333; 
            color: white; 
            border-color: #333; 
            font-weight: bold;
        }
        /* ë¦¬ë·° í‰ì  ìŠ¤íƒ€ì¼ */
        .product-rating {
            margin: 10px 0;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }
        .star-icon { color: #333; font-size: 14px; } /* ë³„ ìƒ‰ìƒ */
        .rating-score { font-weight: bold; color: #333; } /* ì ìˆ˜ (5.0) */
        .review-count { 
            color: #e74c3c; /* ë¦¬ë·° ê°œìˆ˜ëŠ” ë¹¨ê°„ìƒ‰ */
            font-weight: bold; 
            font-size: 13px;
        }
        .review-text { color: #e74c3c; font-size: 13px; }
    </style>
</head>
<body>
    <header>
        <h1>ğŸ›‹ï¸ ì—°ì„±FM </h1>
        <div id="auth-section">
            <button class="btn btn-primary" onclick="location.href='login.html'">ë¡œê·¸ì¸</button>
            <button class="btn" onclick="location.href='register.html'">íšŒì›ê°€ì…</button>
        </div>
    </header> 

    <div id="category-container" class="category-bar">
        </div>
        
    <h2>ìƒí’ˆ ëª©ë¡</h2>
    <div id="product-list" class="product-grid">
        <p>ìƒí’ˆì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            checkLoginStatus();
            loadCategories();
            loadProducts('all');
        });

        function checkLoginStatus() {
            const userStr = localStorage.getItem('user');
            const authSection = document.getElementById('auth-section');

            if (userStr) {
                const user = JSON.parse(userStr);
                authSection.innerHTML = `
                    <span><b>${user.name}</b>ë‹˜</span>
                    <button class="btn" style="background:#6c757d; color:white;" onclick="location.href='mypage.html'">ğŸ“¦ ì£¼ë¬¸ë‚´ì—­</button>
                    <button class="btn btn-cart" onclick="location.href='cart.html'">ğŸ›’ ì¥ë°”êµ¬ë‹ˆ</button>
                    <button class="btn btn-danger" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
                `;
            }
        }

        function logout() {
            localStorage.removeItem('user');
            alert("ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤.");
            window.location.reload();
        }

        async function loadCategories() {
            try {
                const res = await fetch('/api/categories');
                const categories = await res.json();

                const container = document.getElementById('category-container');
                
                // 'ì „ì²´' ë²„íŠ¼ ë¨¼ì € ì¶”ê°€
                let html = `<button class="cat-btn active" onclick="filterCategory('all', this)">ì „ì²´ë³´ê¸°</button>`;
                
                // DBì— ìˆëŠ” ì¹´í…Œê³ ë¦¬ë“¤ ë²„íŠ¼ ì¶”ê°€
                html += categories.map(c => 
                    `<button class="cat-btn" onclick="filterCategory(${c.category_id}, this)">${c.name}</button>`
                ).join('');

                container.innerHTML = html;
            } catch (error) {
                console.error("ì¹´í…Œê³ ë¦¬ ë¡œë“œ ì‹¤íŒ¨", error);
            }
        }
        function filterCategory(id, btnElement) {
            // ëª¨ë“  ë²„íŠ¼ì—ì„œ active í´ë˜ìŠ¤ ì œê±°
            document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
            // í´ë¦­í•œ ë²„íŠ¼ì— active í´ë˜ìŠ¤ ì¶”ê°€ (ê²€ì€ìƒ‰ìœ¼ë¡œ ë³€í•¨)
            btnElement.classList.add('active');
            
            // í•´ë‹¹ ì¹´í…Œê³ ë¦¬ ìƒí’ˆ ë¶ˆëŸ¬ì˜¤ê¸°
            loadProducts(id);
        }
        async function loadProducts(categoryId) {
            try {
                let url = '/api/products';
                if (categoryId && categoryId !== 'all') {
                    url += `?category_id=${categoryId}`;
                }

                const response = await fetch(url);
                const products = await response.json();
                
                const productList = document.getElementById('product-list');
                
                if (products.length === 0) {
                    productList.innerHTML = '<p style="grid-column: 1/-1; text-align: center;">í•´ë‹¹ ì¹´í…Œê³ ë¦¬ì— ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                    return;
                }

                productList.innerHTML = products.map(p => {
                    // í‰ì  ì†Œìˆ˜ì  1ìë¦¬ê¹Œì§€ (ì˜ˆ: 4.5)
                    const rating = Number(p.avg_rating).toFixed(1);
                    
                    return `
                    <div class="product-card">
                        <a href="product.html?id=${p.product_id}" style="text-decoration: none; color: inherit;">
                            <img src="${p.image_url}" alt="${p.name}" onerror="this.src='https://placehold.co/200'">
                            <h3>${p.name}</h3>
                        </a>
                        <p style="color: #888; margin: 5px 0;">${p.category_name}</p>
                        
                        <div class="product-rating">
                            <span class="star-icon">â˜…</span>
                            <span class="rating-score">${rating}</span>
                            <span class="review-text">ë¦¬ë·°</span>
                            <span class="review-count">${p.review_count}</span>
                        </div>

                        <p style="font-weight: bold; font-size: 1.1em; margin-bottom: 10px;">
                            ${p.price.toLocaleString()}ì›
                        </p>
                        
                        <button class="btn btn-secondary" onclick="addToCart(${p.product_id})">ì¥ë°”êµ¬ë‹ˆ</button>
                        <button class="btn btn-primary" onclick="orderProduct(${p.product_id})">ì£¼ë¬¸í•˜ê¸°</button>
                    </div>
                `}).join('');
            } catch (error) {
                console.error("ìƒí’ˆ ë¡œë“œ ì‹¤íŒ¨:", error);
            }
        }

        // âœ… ì¥ë°”êµ¬ë‹ˆ ë‹´ê¸° í•¨ìˆ˜ (ì´ë™ ì•ˆ í•¨)
        async function addToCart(productId) {
            const userStr = localStorage.getItem('user');
            if (!userStr) {
                alert("ë¡œê·¸ì¸ì´ í•„ìš”í•œ ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤.");
                location.href = 'login.html';
                return;
            }
            const user = JSON.parse(userStr);

            try {
                const response = await fetch('/api/cart', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        member_id: user.member_id, 
                        product_id: productId, 
                        quantity: 1 // ëª©ë¡ì—ì„œëŠ” ê¸°ë³¸ 1ê°œ ë‹´ê¸°
                    })
                });

                if (response.ok) {
                    // âœ… ì—¬ê¸°ì„œ ì´ë™í•˜ì§€ ì•Šê³  ì•Œë¦¼ë§Œ ë„ì›ë‹ˆë‹¤!
                    alert("ì¥ë°”êµ¬ë‹ˆì— ë‹´ê²¼ìŠµë‹ˆë‹¤.");
                } else {
                    alert("ë‹´ê¸° ì‹¤íŒ¨");
                }
            } catch (error) {
                console.error(error);
            }
        }

        async function orderProduct(productId) {
            const userStr = localStorage.getItem('user');
            if (!userStr) {
                alert("ë¡œê·¸ì¸ì´ í•„ìš”í•œ ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤.");
                location.href = 'login.html';
                return;
            }
            const user = JSON.parse(userStr);
            if(!confirm("ì´ ìƒí’ˆì„ ë°”ë¡œ ì£¼ë¬¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

            try {
                const response = await fetch('/api/orders', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        member_id: user.member_id,
                        recipient_name: user.name,
                        recipient_phone: user.phone || "010-0000-0000",
                        shipping_address: user.address || "ê¸°ë³¸ ë°°ì†¡ì§€",
                        payment_method: "CARD",
                        items: [{ product_id: productId, quantity: 1 }]
                    })
                });

                const result = await response.json();
                if(response.ok) {
                    alert("ì£¼ë¬¸ ì™„ë£Œ! ì£¼ë¬¸ë²ˆí˜¸: " + result.order_id);
                } else {
                    alert("ì£¼ë¬¸ ì‹¤íŒ¨: " + result.message);
                }
            } catch (error) {
                console.error(error);
                alert("ì£¼ë¬¸ ì¤‘ ì˜¤ë¥˜ ë°œìƒ");
            }
        }
    </script>
</body>
</html>