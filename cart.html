<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì¥ë°”êµ¬ë‹ˆ - Furniture Mall</title>
    <style>
        body { font-family: sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; }
        
        /* í™ˆ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .btn-home { 
            display: inline-block; 
            text-decoration: none; 
            color: #555; 
            font-weight: bold; 
            margin-bottom: 20px; 
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #f8f9fa;
        }
        .btn-home:hover { background-color: #e2e6ea; }

        .cart-item { display: flex; border: 1px solid #ddd; padding: 15px; margin-bottom: 10px; align-items: center; border-radius: 8px; }
        .cart-item img { width: 80px; height: 80px; object-fit: cover; margin-right: 20px; border-radius: 5px; }
        .info { flex-grow: 1; }
        .actions { text-align: right; }
        
        button { padding: 5px 10px; cursor: pointer; border: 1px solid #ccc; border-radius: 4px; background-color: white; }
        button:hover { background-color: #f0f0f0; }
        
        /* ì‚­ì œ ë²„íŠ¼ì€ ë¹¨ê°„ìƒ‰ìœ¼ë¡œ */
        .btn-delete { color: #dc3545; border-color: #dc3545; }
        .btn-delete:hover { background-color: #dc3545; color: white; }

        .btn-order { background: #28a745; color: white; padding: 15px; width: 100%; border: none; font-size: 18px; margin-top: 20px; border-radius: 5px; }
        .btn-order:hover { background-color: #218838; }
        
        input[type="number"] { width: 50px; padding: 5px; text-align: center; }
    </style>
</head>
<body>
    <a href="index.html" class="btn-home">â† ì‡¼í•‘ ê³„ì†í•˜ê¸° (í™ˆìœ¼ë¡œ)</a>

    <h1>ğŸ›’ ì¥ë°”êµ¬ë‹ˆ</h1>
    <div id="cart-list">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
    
    <div style="text-align: right; margin-top: 20px; padding-top: 20px; border-top: 2px solid #eee;">
        <h3>ì´ ê²°ì œê¸ˆì•¡: <span id="total-price">0</span>ì›</h3>
    </div>
    
    <button class="btn-order" onclick="orderAll()">ì „ì²´ ì£¼ë¬¸í•˜ê¸°</button>

    <script>
        let cartData = [];
        const user = JSON.parse(localStorage.getItem('user'));

        async function loadCart() {
            if (!user) { alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤."); location.href='login.html'; return; }

            const res = await fetch(`/api/cart?member_id=${user.member_id}`);
            cartData = await res.json();
            
            const list = document.getElementById('cart-list');
            let total = 0;
            
            // 1. ì¥ë°”êµ¬ë‹ˆê°€ ë¹„ì—ˆì„ ë•Œ
            if(cartData.length === 0) {
                list.innerHTML = "<div style='text-align:center; padding: 50px; color: #888;'>ì¥ë°”êµ¬ë‹ˆê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.</div>";
                document.getElementById('total-price').innerText = "0";
                return;
            }

            // 2. ìƒí’ˆ ëª©ë¡ í‘œì‹œ
            list.innerHTML = cartData.map(item => {
                total += item.price * item.quantity;
                return `
                <div class="cart-item">
                    <img src="${item.image_url}" onerror="this.src='https://placehold.co/100'">
                    <div class="info">
                        <h3>${item.name}</h3>
                        <p>${parseInt(item.price).toLocaleString()}ì›</p>
                    </div>
                    <div class="actions">
                        ìˆ˜ëŸ‰: <input type="number" value="${item.quantity}" min="1" onchange="updateQty(${item.cart_id}, this.value)">
                        <button class="btn-delete" onclick="deleteItem(${item.cart_id})">ì‚­ì œ</button>
                    </div>
                </div>`;
            }).join('');
            
            document.getElementById('total-price').innerText = parseInt(total).toLocaleString();
        }

        async function updateQty(cartId, qty) {
            if(qty < 1) return alert("ìˆ˜ëŸ‰ì€ 1ê°œ ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.");
            await fetch(`/api/cart/${cartId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ quantity: qty })
            });
            loadCart();
        }

        async function deleteItem(cartId) {
            if(!confirm('ì¥ë°”êµ¬ë‹ˆì—ì„œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            await fetch(`/api/cart/${cartId}`, { method: 'DELETE' });
            loadCart();
        }

        async function orderAll() {
            if(cartData.length === 0) return alert("ì£¼ë¬¸í•  ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.");
            if(!confirm("ì¥ë°”êµ¬ë‹ˆì˜ ëª¨ë“  ìƒí’ˆì„ ì£¼ë¬¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

            const orderData = {
                member_id: user.member_id,
                recipient_name: user.name,
                recipient_phone: "010-0000-0000",
                shipping_address: "ê¸°ë³¸ ë°°ì†¡ì§€",
                payment_method: "CARD",
                items: cartData.map(item => ({ 
                    product_id: item.product_id, 
                    quantity: item.quantity 
                }))
            };

            try {
                const res = await fetch('/api/orders', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(orderData)
                });

                const result = await res.json();

                if(res.ok) {
                    alert("ì£¼ë¬¸ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!");
                    loadCart(); // ì¥ë°”êµ¬ë‹ˆ ë¹„ìš°ê¸° í™•ì¸
                } else {
                    alert("ì£¼ë¬¸ ì‹¤íŒ¨: " + result.message);
                }
            } catch (error) {
                console.error(error);
                alert("ì„œë²„ í†µì‹  ì˜¤ë¥˜");
            }
        }

        loadCart();
    </script>
</body>
</html>